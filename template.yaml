Transform: AWS::Serverless-2016-10-31

Parameters:
  ParentDomain:
    Type: String
    Description: Your domain name, eh megacorp.com

  DomainName:
    Type: String
    Description: name of subdomain for registry, eg terraform

  CertificateARN:
    Type: String
    Description: >
      If you already have a certificate in AWS Certificate Manager that covers the DomainName supply the ARN here. This will skip creation
      of a new certificate.

  APIEndpointType:
    Type: String
    Description: >
      REGIONAL or EDGE . When using EDGE, the Certificate must be located in us-east-1. Either deploy the entire stack in us-east-1 or pass in the arn of a certificate in us-east-1.
    AllowedValues:
      - REGIONAL
      - EDGE
    Default: REGIONAL

Conditions:
  CreateCertificate: !Equals [!Ref CertificateARN, ""]
  RegionalAPIEndpoint: !Equals [!Ref APIEndpointType, REGIONAL]

Resources:
  DeletionPolicy: Retain
  UpdateReplacePolicy: Retain
  Storage:
    Type: AWS::S3::Bucket
    Properties:
      LifecycleConfiguration:
        Rules:
          - AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
            NoncurrentVersionExpirationInDays: 21
            Status: Enabled
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true

  DB:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::DynamoDB::Table
    Properties:
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  Certificate:
    Condition: CreateCertificate
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Sub ${ParentDomain}.${DomainName}
      ValidationMethod: DNS

  APIDomainName:
    Type: AWS::ApiGateway::DomainName
    Properties:
      RegionalCertificateArn: !If
        - CreateCertificate
        - !Ref Certificate
        - !Ref CertificateARN
      EndpointConfiguration:
        Types:
          - !Ref APIEndpointType
      DomainName: !Sub ${ParentDomain}.${DomainName}

  RegistryMapping:
    Type: AWS::ApiGateway::BasePathMapping
    Properties:
      DomainName: !Ref DomainName
      RestApiId: !Ref API
      Stage: main

  API:
    DependsOn:
      - Role
      - WebHookRole
    Type: AWS::Serverless::Api
    Properties:
      StageName: main
      EndpointConfiguration:
        Type: !Ref APIEndpointType
      DisableExecuteApiEndpoint: true
      MethodSettings:
        - ResourcePath: /*
          HttpMethod: "*"
          DataTraceEnabled: true
          LoggingLevel: ERROR
      Variables:
        registry_db: !Ref DB
        event_bus: !GetAtt EventBus.Arn
        github_host: github.com
      DefinitionBody:
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: openapi.yaml

  Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: DynamoDBAccess
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub apigateway.${AWS::URLSuffix}
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DBRead
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource: !GetAtt DB.Arn
              - Effect: Allow
                Action:
                  - stepfunctions:StateExecution
                Resource: !GetAtt GitHubEventRouter.Arn

  EventRouterRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub states.${AWS::Region}.${AWS::URLSuffix}
            Action: sts:AssumeRole
      Policies:
        - PolicyName: WriteEvents
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource: !GetAtt EventBus.Arn

  GitHubWebHookRouter:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      DefinitionS3Location: webhook-github.asl.yaml
      RoleArn: !GetAtt EventRouterRole.Arn
      TracingConfiguration:
        Enabled: True

  EventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: TFRegistry

  WebHookRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub events.${AWS::URLSuffix}
            Action: sts:AssumeRole
      Policies:
        - PolicyName: EventBridge
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: events:PutEvents
                Resource: !GetAtt EventBus.Arn

  Authorizer:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub RegistryAuthorizer-${AWS::Region}
      Architectures:
        - arm64
      Handler: index.handler
      Code:
        ZipFile: |
          exports.handler = (event, context) => console.log("hello world")
      Runtime: nodejs16.x
      Role: !Ref AuthorizerExecutionRole
      TracingConfig:
        Mode: Active
      MemorySize: 128

  AuthorizerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub lambda.${AWS::URLSuffix}
            Action: sts:AssumeRole

  UserPool:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Cognito::UserPool

  UserClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool

  VCSClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ClientName: VCS_OIDC_CLIENT
      AllowedOAuthFlows:
        - client_credentials

  IdentityProvider:
    Type: AWS::Cognito::UserPoolIdentityProvider
    Properties:
      ProviderName: IdentityProvider
      ProviderType: OIDC
      UserPoolId: !Ref UserPool

  UserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Ref ParentDomain
      UserPoolId: !Ref UserPool

Outputs:
  APIDomainName:
    Condition: RegionalAPIEndpoint
    Description: Create a DNS record <DomainName> for pointing to this DomainName
    Value: !GetAtt APIDomainName.RegionalDomainName

  OIDCWellKnownCOnfigurationUrl:
    Description: OIDC /.well-known/openid-configuration Url
    Value: !Sub "https://cognito-idp.${AWS::Region}.amazonaws.com/${UserPool}/.well-known/openid-configuration"

  OIDCJWKSJSONUrl:
    Description: OIDC /.well-known/jwks.json Url"
    Value: !Sub "https://cognito-idp.${AWS::Region}.amazonaws.com/${UserPool}/.well-known/jwks.json"
